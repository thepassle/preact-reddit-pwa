{"version":3,"file":"index.js","sources":["../dist-src/index.js"],"sourcesContent":["import path from 'path';\nimport { promises as fs } from 'fs';\nimport yargs from 'yargs-parser';\nimport resolveFrom from 'resolve-from';\nimport detectIndent from 'detect-indent';\nimport execa from 'execa';\nimport chalk from 'chalk';\nconst EXECA_OPTIONS = { stdio: [process.stdin, process.stdout, process.stderr] };\nlet isNoop = false;\nconst output = [];\nfunction log(...args) {\n    output.push([...args]);\n    console.log(...args);\n}\nasync function runPackage(args) {\n    if (isNoop) {\n        log(['npx', ...args]);\n        return;\n    }\n    return execa('npx', [...args], EXECA_OPTIONS);\n}\nasync function getPackageManifest(dir = path.join(__dirname, '..')) {\n    const packageManifestLoc = path.join(dir, 'package.json');\n    const packageManifestStr = await fs.readFile(packageManifestLoc, { encoding: 'utf8' });\n    return { pkg: JSON.parse(packageManifestStr), indent: detectIndent(packageManifestStr).indent || undefined };\n}\nasync function savePackageManifest(dir, { pkg, indent }) {\n    return fs.writeFile(path.join(dir, 'package.json'), JSON.stringify(pkg, null, indent || 2) + '\\n', { encoding: 'utf8' });\n}\nfunction printHelp() {\n    log(`\n${chalk.bold('Usage:')}\n  pika [command] [flags]\n${chalk.bold('Commands:')}\n  help                output usage information\n  build               ${chalk.underline('https://www.pika.dev/cli/commands/build')}\n  install             ${chalk.underline('https://www.pika.dev/cli/commands/install')}\n  publish             ${chalk.underline('https://www.pika.dev/cli/commands/publish')}\n${chalk.bold('Global Options:')}\n  -v, --version       output the CLI version\n  -h, --help          output usage information\n  --cwd               set the current\n  --dry-run           don't actually run any commands\n`.trim());\n}\nasync function runExternalCommand(command, commandArgs, parsedArgs) {\n    const cwd = parsedArgs.cwd || process.cwd();\n    if (command === 'install') {\n        const hasLocalInstall = !!resolveFrom.silent(cwd, '@pika/web');\n        await runPackage([hasLocalInstall ? 'pika-web' : '@pika/web', ...commandArgs]);\n        return [true, !hasLocalInstall && '@pika/web'];\n    }\n    if (command === 'build') {\n        const hasLocalInstall = !!resolveFrom.silent(cwd, '@pika/pack');\n        await runPackage([hasLocalInstall ? 'pika-pack' : '@pika/pack', ...commandArgs]);\n        return [true, !hasLocalInstall && '@pika/pack'];\n    }\n    if (command === 'publish') {\n        const { pkg, indent } = await getPackageManifest(cwd);\n        if (!pkg.scripts.version) {\n            log(`${chalk.bold('missing \"version\" script:')} You'll need to create a fresh build after bumping the master package.json version.`);\n            if (pkg.scripts.build) {\n                pkg.scripts.version = 'npm run build';\n            }\n            else {\n                pkg.scripts.version = 'npx @pika/pack';\n            }\n            log(`Adding the following \"version\" lifecycle script to your package.json... ` + chalk.bold(`\"${pkg.scripts.version}\"`));\n            await savePackageManifest(cwd, { pkg, indent });\n            log(`Please review & commit this change before publishing.`);\n            return [true, undefined];\n        }\n        const hasLocalInstall = !!resolveFrom.silent(cwd, 'np');\n        const contentsArg = parsedArgs.contents ? [] : ['--contents', parsedArgs.contents || 'pkg/'];\n        await runPackage(['np', ...commandArgs, ...contentsArg]);\n        return [true, !hasLocalInstall && 'np'];\n    }\n    return [false, undefined];\n}\nexport async function cli(args) {\n    // Convert: pika help build [...] => pika build --help [...]\n    if (args[2] === 'help' && args[3] && !args[3].startsWith('-')) {\n        return cli([args[0], args[1], args[3], '--help', ...args.slice(4)]);\n    }\n    const parsedArgs = yargs(args.slice(2));\n    const commandArgs = args.slice(3);\n    const command = args[2] || 'help';\n    isNoop = parsedArgs.dryRun || isNoop;\n    if (parsedArgs.version) {\n        log((await getPackageManifest()).pkg.version);\n        return output;\n    }\n    if (command === 'help') {\n        printHelp();\n        return output;\n    }\n    const [wasRecognized, recommendedDep] = await runExternalCommand(command, commandArgs, parsedArgs);\n    if (!wasRecognized) {\n        log(`Command ${chalk.bold(command)} not recognized.`);\n        printHelp();\n        return output;\n    }\n    if (recommendedDep) {\n        log(chalk.bgYellowBright(`TIP!`), `Speed up the command next time by installing`, chalk.bold(recommendedDep), `locally.`);\n    }\n    return output;\n}\n"],"names":["EXECA_OPTIONS","stdio","process","stdin","stdout","stderr","isNoop","output","log","args","push","console","runPackage","execa","getPackageManifest","dir","path","join","__dirname","packageManifestLoc","packageManifestStr","fs","readFile","encoding","pkg","JSON","parse","indent","detectIndent","undefined","savePackageManifest","writeFile","stringify","printHelp","chalk","bold","underline","trim","runExternalCommand","command","commandArgs","parsedArgs","cwd","hasLocalInstall","resolveFrom","silent","scripts","version","build","contentsArg","contents","cli","startsWith","slice","yargs","dryRun","wasRecognized","recommendedDep","bgYellowBright"],"mappings":"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"}